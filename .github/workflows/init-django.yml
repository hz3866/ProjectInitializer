name: Init Django Project

on:
  workflow_dispatch:
    inputs:
      project_name:
        description: 'Project Name (will be used as new repository name)'
        required: true
        type: string

      python_version:
        description: 'Python Version'
        required: true
        type: choice
        options:
          - '3.10'
          - '3.11'
          - '3.12'
        default: '3.11'

      django_version:
        description: 'Django Version'
        required: true
        type: choice
        options:
          - '4.2'
          - '5.0'
          - '5.1'
        default: '5.0'

      repo_visibility:
        description: 'Repository Visibility'
        required: true
        type: choice
        options:
          - 'public'
          - 'private'
        default: 'public'

jobs:
  create-django:
    runs-on: ubuntu-latest
    steps:
      - name: Validate project name
        run: |
          if [[ ! "${{ inputs.project_name }}" =~ ^[a-zA-Z][a-zA-Z0-9_]*$ ]]; then
            echo "::error::Invalid project name. Must start with a letter and contain only letters, numbers, and underscores."
            exit 1
          fi

      # Checkout this repo to get templates
      - name: Checkout templates
        uses: actions/checkout@v4
        with:
          path: templates-repo

      - name: Set up Python ${{ inputs.python_version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ inputs.python_version }}

      - name: Install Django
        run: |
          pip install --upgrade pip
          pip install Django~=${{ inputs.django_version }}.0

      - name: Create Django project
        run: |
          django-admin startproject ${{ inputs.project_name }}
          cd ${{ inputs.project_name }}
          
          # Create requirements.txt
          cat > requirements.txt << 'EOF'
          Django~=${{ inputs.django_version }}.0
          python-dotenv>=1.0.0
          gunicorn>=21.0.0
          EOF
          
          # Create release.yaml
          cat > release.yaml << 'EOF'
          version: "0.1.0"
          EOF

      - name: Copy template files
        run: |
          cd ${{ inputs.project_name }}
          
          # Copy shared files (CI/CD workflow)
          mkdir -p .github/workflows
          cp ../templates-repo/templates/shared/.github/workflows/docker-build-push.yml .github/workflows/
          
          # Copy Django-specific files
          cp ../templates-repo/templates/django/.gitignore .
          cp ../templates-repo/templates/django/.env.example .
          
          # Process Dockerfile template (replace placeholders)
          sed -e 's/{{PYTHON_VERSION}}/${{ inputs.python_version }}/g' \
              -e 's/{{PROJECT_NAME}}/${{ inputs.project_name }}/g' \
              ../templates-repo/templates/django/Dockerfile.template > Dockerfile

      - name: Create README
        run: |
          cd ${{ inputs.project_name }}
          cat > README.md << 'EOF'
          # ${{ inputs.project_name }}
          
          A Django project.
          
          ## Tech Stack
          
          - Python: ${{ inputs.python_version }}
          - Django: ${{ inputs.django_version }}
          
          ## Quick Start
          
          ```bash
          # Create virtual environment
          python -m venv venv
          source venv/bin/activate  # On Windows: venv\Scripts\activate
          
          # Install dependencies
          pip install -r requirements.txt
          
          # Setup environment
          cp .env.example .env
          
          # Run migrations
          python manage.py migrate
          
          # Create superuser (optional)
          python manage.py createsuperuser
          
          # Run development server
          python manage.py runserver
          ```
          
          ## Docker
          
          ```bash
          # Build image
          docker build -t ${{ inputs.project_name }}:latest .
          
          # Run container
          docker run -p 8000:8000 ${{ inputs.project_name }}:latest
          ```
          
          ## CI/CD
          
          This project includes a GitHub Action workflow for automatic Docker image builds:
          - Triggers on push to main/master branch
          - Can be manually triggered via workflow_dispatch
          - Pushes images to DockerHub
          - Runs Trivy security scan
          
          ### Required GitHub Secrets
          
          | Secret | Description |
          |--------|-------------|
          | `DOCKERHUB_USERNAME` | Your DockerHub username |
          | `DOCKERHUB_TOKEN` | Your DockerHub access token |
          EOF

      - name: Create repo and push
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          cd ${{ inputs.project_name }}
          git config --global user.name "${{ github.actor }}"
          git config --global user.email "${{ github.actor }}@users.noreply.github.com"
          git init
          git add .
          git commit -m "Initial Django ${{ inputs.django_version }} project"
          gh repo create ${{ inputs.project_name }} --${{ inputs.repo_visibility }} --source . --push
          echo "âœ… Repo created: https://github.com/${{ github.repository_owner }}/${{ inputs.project_name }}"

      - name: Create poc branch
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          cd ${{ inputs.project_name }}
          git remote set-url origin https://x-access-token:${GH_TOKEN}@github.com/${{ github.repository_owner }}/${{ inputs.project_name }}.git
          git checkout -b poc
          git push -u origin poc
          git checkout master
          echo "âœ… Branch 'poc' created"

      - name: Set secrets for new repo
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          REPO="${{ github.repository_owner }}/${{ inputs.project_name }}"
          echo "ðŸ” Setting secrets for ${REPO}..."
          echo "${{ secrets.DOCKERHUB_USERNAME }}" | gh secret set DOCKERHUB_USERNAME --repo ${REPO}
          echo "${{ secrets.DOCKERHUB_TOKEN }}" | gh secret set DOCKERHUB_TOKEN --repo ${REPO}
          echo "âœ… Secrets configured"

      - name: Enable GitHub Actions
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          REPO="${{ github.repository_owner }}/${{ inputs.project_name }}"

          # Enable Actions for the repository
          gh api \
            --method PUT \
            -H "Accept: application/vnd.github+json" \
            /repos/${REPO}/actions/permissions \
            -f enabled=true \
            -f allowed_actions=all

          # Set workflow permissions to read-write (if needed)
          gh api \
            --method PUT \
            -H "Accept: application/vnd.github+json" \
            /repos/${REPO}/actions/permissions/workflow \
            -f default_workflow_permissions=write \
            -f can_approve_pull_request_reviews=true

          echo "âœ… GitHub Actions enabled"