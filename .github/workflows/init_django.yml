name: Init Django Project

on:
  workflow_dispatch:
    inputs:
      python_version:
        description: 'Python Version'
        required: true
        type: choice
        options:
          - '3.9'
          - '3.10'
          - '3.11'
          - '3.12'
        default: '3.11'
      django_version:
        description: 'Django Version'
        required: true
        type: choice
        options:
          - '4.2'
          - '5.0'
          - '5.1'
        default: '5.0'
      project_name:
        description: 'Project Name (will be used as new repository name)'
        required: true
        type: string

jobs:
  create-django-project:
    runs-on: ubuntu-latest

    steps:
      - name: Validate project name
        run: |
          if [[ ! "${{ github.event.inputs.project_name }}" =~ ^[a-zA-Z][a-zA-Z0-9_-]*$ ]]; then
            echo "Error: Invalid project name"
            exit 1
          fi

      - name: Set up Python ${{ github.event.inputs.python_version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ github.event.inputs.python_version }}

      - name: Install Django
        run: |
          pip install --upgrade pip
          pip install Django~=${{ github.event.inputs.django_version }}.0

      - name: Create Django project
        run: |
          django-admin startproject ${{ github.event.inputs.project_name }}
          cd ${{ github.event.inputs.project_name }}
          
          cat > requirements.txt << EOF
          Django~=${{ github.event.inputs.django_version }}.0
          EOF
          
          cat > .gitignore << 'EOF'
          __pycache__/
          *.py[cod]
          venv/
          .venv/
          *.log
          db.sqlite3
          .env
          .idea/
          .vscode/
          .DS_Store
          EOF
          
          cat > README.md << EOF
          # ${{ github.event.inputs.project_name }}
          
          - Python: ${{ github.event.inputs.python_version }}
          - Django: ${{ github.event.inputs.django_version }}
          
          ## Quick Start
          
          \`\`\`bash
          python -m venv venv
          source venv/bin/activate
          pip install -r requirements.txt
          python manage.py migrate
          python manage.py runserver
          \`\`\`
          EOF

      - name: Create repo and push
        env:
          GH_TOKEN: ${{ secrets.PAT_TOKEN }}
        run: |
          cd ${{ github.event.inputs.project_name }}
          git config --global user.name "${{ github.actor }}"
          git config --global user.email "${{ github.actor }}@users.noreply.github.com"
          git init
          git add .
          git commit -m "Initial Django ${{ github.event.inputs.django_version }} project"
          gh repo create ${{ github.event.inputs.project_name }} --public --source . --push
          echo "Done: https://github.com/${{ github.repository_owner }}/${{ github.event.inputs.project_name }}"